# ARCHS4

Load libraries
```{r load_libraries}
library(bigstatsr)
library(data.table)
library(dplyr)
library(rsvd)
library(glmnet)
library(Matrix)
library(knitr)
library(here)
library(hdf5r)
library(biomaRt)
```

Settings

```{r settings}
DATASET_NAME <- "archs4_full"
N_CORES <- nb_cores() %/% 3
CHUNK_SIZE <- 1000

GENES_MEAN_CUTOFF <- 1
GENES_VAR_CUTOFF <- 0.1

# number of samples 888821
# square root of 888821 = 942, using as a k
K <- 942
PLIER_MULTIPLIER <- 3
PLIER_MAX_U_UPDATES <- 3
PLIER_MAX_ITER <- 350
```

Output 

```{r output_paths}
output_nb_path <- here(file.path("output/vignettes/plier2_testing/", DATASET_NAME))
dir.create(output_nb_path, showWarnings = FALSE, recursive = TRUE)
```

Load the local files

```{r load_functions}
source(here("R/solvers.R"))
source(here("R/utilsNew.R"))
```

Download ARCHS4 

```{r download_archs4_if_needed, eval = TRUE, echo = TRUE, message = TRUE}
url <- "https://s3.dev.maayanlab.cloud/archs4/files/human_gene_v2.5.h5"
output_dir <- here::here("data", "archs4")
output_file <- file.path(output_dir, "human_gene_v2.5.h5")

if (!file.exists(output_file)) {
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  command <- sprintf("wget -c '%s' -O '%s'", url, output_file)
  tryCatch({
    system(command)
    cat("File downloaded successfully to:", output_file, "\n")
  }, error = function(e) {
    cat("Error during download:", e$message, "\n")
  })
} else {
  cat("File already exists. Skipping download.\n")
}
```

Read in ARCHS4 file 

```{r read_input_data}
file_path <- here("data/archs4/human_gene_v2.5.h5")
h5        <- H5File$new(file_path, mode = "r")
dset      <- h5[["/data/expression"]]
gene_symbols <- h5[["/meta/genes/symbol"]]$read()
gene_ids     <- h5[["/meta/genes/ensembl_gene"]]$read()
sample_names <- h5[["/meta/samples/geo_accession"]]$read()
n_genes      <- length(gene_symbols)
n_samples    <- length(sample_names)
```

Get gene lengths for this Ensembl version

```{r get_gene_lengths}
# TODO: check, I'm not entirely sure if this is the best way to get gene
# lengths (using EDASeq, below, was giving an error)
output_file <- file.path(output_nb_path, "gene_lengths.rds")

if (!file.exists(output_file)) {
  ensembl_ver <- 107
  ensembl <- useEnsembl(biomart="ensembl", version=ensembl_ver)
  mart <- biomaRt::useDataset("hsapiens_gene_ensembl", ensembl)
  gene_info <- biomaRt::getBM(
    filters = "hgnc_symbol",
    attributes = c("ensembl_gene_id", "hgnc_symbol", "transcript_length"),
    values = gene_symbols, 
    mart = mart
  )

  gene_lengths <- gene_info %>%
    group_by(hgnc_symbol, ensembl_gene_id) %>%
    summarize(gene_length_bp = max(transcript_length, na.rm = TRUE)) %>%
    pull(gene_length_bp, name = hgnc_symbol)

  saveRDS(gene_lengths, file = output_file)
} else {
  gene_lengths <- readRDS(output_file)
  cat("File already exists. Skipping download.\n")
}

#if (!file.exists(output_file)) {
#  gene_lengths <- EDASeq::getGeneLengthAndGCContent(gene_ids, "hsa")
#  saveRDS(gene_lengths, file = output_file)
#} else {
#  gene_lengths <- readRDS(output_file)
#  cat("File already exists. Skipping download.\n")
#}
```

```{r adjust_gene_symbols}
# keep in data only genes for which we have lengths
gene_symbols_idx <- which( gene_symbols %in% names(gene_lengths) )
gene_symbols_thin <- gene_symbols[gene_symbols_idx]
gene_lengths <- gene_lengths[gene_symbols_thin]
n_genes_thin <- length(gene_symbols_thin)
```

Create or open FBM matrix

```{r create_fbm}
fbm_file  <- file.path(output_nb_path, "FBMfull")

# file fbm_file exists, we open it, not create it.
fbm_file_exists <- file.exists(paste0(fbm_file, ".bk"))

fbm_obj <- FBM(
  nrow        = n_genes_thin,
  ncol        = n_samples,
#  type        = "float",
  backingfile = fbm_file,
  create_bk   = !fbm_file_exists,
)
```

Populate it with data

```{r populate_fbm}
block_size <- CHUNK_SIZE
n_blocks   <- ceiling(n_samples / block_size)

if (!fbm_file_exists) {
  pb <- txtProgressBar(min = 0, max = n_blocks, style = 3)

  for (i in 1:n_blocks) {
    setTxtProgressBar(pb, i)

    start_row <- (i-1) * block_size + 1
    end_row <- min(i * block_size, n_samples)

    # tpm
    raw_block <- NULL
    tryCatch(
      expr = {
        raw_block <- dset[start_row:end_row, ]
      },
      error = function(e) {
        message(paste("Error with block: ", i))
      }
    )
    if (is.null(raw_block)) {
      # FIXME: I add a dummy block here with near-to-zero values; not sure if
      # this is the best approach here; for some reason, there is a block that
      # cannot be read in ARCHS4, so I "skip" it here
      raw_block <- matrix(1e-10, (end_row - start_row + 1), n_genes)
    }

    raw_block <- raw_block[, gene_symbols_idx]
    raw_block <- t(tpm_norm(raw_block, gene_lengths))

    fbm_obj[, start_row:end_row] <- as.matrix(raw_block)
  }

	# run cleanFBM (log, NAs handling, etc)
  cleanFBM(fbm_obj, ncores=N_CORES)
} else {
  message("FBM file already exists")
}
```

Once done, close h5 file

```{r close_h5}
h5$close_all()
```

Compute gene stats

```{r get_fbm_stats_and_plot}
output_file <- file.path(output_nb_path, "row_stats.rds")

if (!file.exists(output_file)) {
  rowStats=computeRowStatsFBM(fbm_obj, ncores=N_CORES)
  saveRDS(rowStats, file = output_file)

  png(filename=file.path(output_nb_path, "gene_means_and_vars.png"))
  plot(rowStats$row_means, rowStats$row_variances, log="y")
  dev.off()
} else {
  rowStats <- readRDS(output_file)
}
```

Filter the data. Doing aggressive filtering to reduce the number of genes.

```{r filter_fbm_and_zscore}
output_file <- paste0(fbm_file, "_filtered")
kept_rows_output_file <- file.path(output_nb_path, "kept_rows.rds")

if (!file.exists(output_file)) {
	filterResult=filterFBM(
		fbm_obj,
		rowStats,
		mean_cutoff = GENES_MEAN_CUTOFF,
		var_cutoff = GENES_VAR_CUTOFF,
		backingfile = output_file
	)

  saveRDS(filterResult$kept_rows, kept_rows_output_file)

  # TODO: add a way to check if this needs to be done
	rowStats$row_means=rowStats$row_means[filterResult$kept_rows]
	rowStats$row_variances=rowStats$row_variances[filterResult$kept_rows]
  zscoreFBM(filterResult$fbm_filtered, rowStats = rowStats, chunk_size=CHUNK_SIZE)
  # zscoreFBM_opt(fbm_obj_filtered, ncores=N_CORES)
} else {
  filterResult <- list()

	filterResult$fbm_filtered <- FBM(
		nrow        = n_genes_thin,
		ncol        = n_samples,
		backingfile = fbm_file,
		create_bk   = !fbm_file_exists,
	)

  filterResult$kept_rows <- readRDS(kept_rows_output_file)
}

fbm_obj_filtered=filterResult$fbm_filtered
message(paste("New filtered dataset dims: ", nrow(fbm_obj_filtered), " x ", ncol(fbm_obj_filtered)))

gene_symbols_thin=gene_symbols_thin[filterResult$kept_rows]
message(paste("Number of genes kept: ", length(gene_symbols_thin)))

```

Save the FBM object for quick loading

```{r save_fbm_filtered}
#fbm_obj_filtered$save()

meta <- list()
meta$rowNames <- gene_symbols_thin
meta$colNames <- sample_names
saveRDS(meta, paste0(fbm_file, "_meta.RDS"))
```

Precompute the SVD

```{r randomSVD}
fbm_obj.svd=big_randomSVD(
  fbm_obj_filtered,
  k = K,
  ncores = N_CORES
)
```

Run simpleDecomp as the base model 

```{r simpleDecomp}
decomp_file <- file.path(output_nb_path, "simpleDecompResult.RDS")

if (!file.exists(decomp_file)) {
  fbm_obj.sdres <- simpleDecomp(
    fbm_obj_filtered,
    k = K,
    svdres = fbm_obj.svd,
    ncores = N_CORES
  )

  saveRDS(fbm_obj.sdres, file = decomp_file)
} else {
  fbm_obj.sdres <- readRDS(decomp_file)
}
```

Download some pathways

```{r get_pathways}
# FIXME: we should download the pathways before and only once, and then load
# them here
gmtList=list()

gmtList[["Wiki"]]=getGMT("https://maayanlab.cloud/Enrichr/geneSetLibrary?mode=text&libraryName=WikiPathway_2021_Human")
gmtList[["MGI"]]=getGMT("https://maayanlab.cloud/Enrichr/geneSetLibrary?mode=text&libraryName=MGI_Mammalian_Phenotype_Level_4_2021")
gmtList[["GO"]]=getGMT("https://maayanlab.cloud/Enrichr/geneSetLibrary?mode=text&libraryName=GO_Biological_Process_2023")
gmtList[["Reactome"]]=getGMT("https://maayanlab.cloud/Enrichr/geneSetLibrary?mode=text&libraryName=Reactome_2022")
gmtList[["CellMarkers"]]=getGMT("https://maayanlab.cloud/Enrichr/geneSetLibrary?mode=text&libraryName=CellMarker_2024")
```

Create a pathMat object and save
```{r assemble_path_matrix}
pathMat = gmtListToSparseMat(gmtList[c(5)])
#saveRDS(gmtList, "gmtList.RDS")
#saveRDS(pathMat, "pathMat.RDS")
```

Get a matched pathway set
The FBM version doesn't do any subsetting, everything has to match exactly

```{r get_chat}
matchedPaths=getMatchedPathwayMat(pathMat, meta$rowNames)
Chat=getChat(matchedPaths, method = "fast")
```

# Run PLIER2

```{r run_plier2}
fbm_obj.plier2 <- PLIERv2(
  fbm_obj_filtered,
  matchedPaths,
  sdres = fbm_obj.sdres,
  Chat = Chat,
  doCrossval = T,
  multiplier = PLIER_MULTIPLIER,
  max.U.updates = PLIER_MAX_U_UPDATES,
  max.iter = PLIER_MAX_ITER,
  k = K,
  ncores=N_CORES
)

saveRDS(fbm_obj.plier2, file = file.path(output_nb_path, paste0(DATASET_NAME, "_PLIER2.rds")))
```

